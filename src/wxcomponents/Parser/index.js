// 小程序富文本插件 https://github.com/jin-yufeng/Parser
"use strict";function Hash(t){for(var e=t.length,n=5381;e--;)n+=(n<<5)+t.charCodeAt(e);return n}function Deduplication(t){if(0!=t.indexOf("http"))return t;for(var e="",n=0;n<t.length&&(e+=Math.random()>=.5?t[n].toUpperCase():t[n].toLowerCase(),"/"!=t[n]||"/"==t[n-1]||"/"==t[n+1]);n++);return e+=t.substring(n+1)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},parseHtmlSync=require("./libs/MpHtmlParser.js").parseHtmlSync,cache=getApp().parserCache={},CssHandler=require("./libs/CssHandler.js"),config=require("./libs/config.js"),document;try{document=require("./libs/document.js")}catch(t){}var hideAnimation=wx.createAnimation({timingFunction:"ease"}).opacity(0).step().export(),showAnimation=wx.createAnimation({timingFunction:"ease"}).opacity(1).step().export();Component({properties:{html:{type:null,value:null,observer:function(t){if(this._refresh)return this._refresh=!1;this.setContent(t,void 0,!0)}},autocopy:{type:Boolean,value:!0},autopause:{type:Boolean,value:!0},autopreview:{type:Boolean,value:!0},autosetTitle:{type:Boolean,value:!0},domain:{type:String,value:null},imgMode:{type:String,value:"default"},lazyLoad:{type:Boolean,value:!1},selectable:{type:Boolean,value:!1},tagStyle:{type:Object,value:{}},showWithAnimation:{type:Boolean,value:!1},useAnchor:{type:Boolean,value:!1},useCache:{type:Boolean,value:!1}},created:function(){var t=this;this.navigateTo=function(e){var n=t.createSelectorQuery();n.select("#contain"+(e.id?">>>#"+e.id:"")).boundingClientRect(),n.selectViewport().scrollOffset(),n.exec(function(t){if(!t||!t[0])return e.fail?e.fail({errMsg:"Label Not Found"}):null;wx.pageScrollTo({scrollTop:t[1].scrollTop+t[0].top,success:e.success,fail:e.fail})})},this.getText=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],n="";if(!t.data.html||!t.data.html.length)return"";for(var o=0;o<t.data.html.length;o++)!function t(o){if("text"==o.type)return n+=o.text;if(e&&(("p"==o.name||"div"==o.name||"tr"==o.name||"li"==o.name||/h[1-6]/.test(o.name))&&n&&"\n"!=n[n.length-1]||"br"==o.name)&&(n+="\n"),o.children)for(var a=0;a<o.children.length;a++)t(o.children[a]);e&&("p"==o.name||"div"==o.name||"tr"==o.name||"li"==o.name||/h[1-6]/.test(o.name))&&n&&"\n"!=n[n.length-1]?n+="\n":e&&"td"==o.name&&(n+="\t")}(t.data.html[o]);return n},this.getVideoContext=function(e){if(!e)return t.videoContexts;for(var n=t.videoContexts.length;n--;)if(t.videoContexts[n].id==e)return t.videoContexts[n];return null},this.imgList=[],this.imgList.each=function(t){for(var e=0;e<this.length;e++){var n=t(this[e],e,this);n&&(this.includes(n)?this[e]=Deduplication(n):this[e]=n)}},this._refresh=!1,this.setContent=function(e,n,o){if("object"==(void 0===n?"undefined":_typeof(n)))for(var a in n)a=a.replace(/-(\w)/g,function(t,e){return e.toUpperCase()}),t.data[a]=n[a];var i={controls:{imgMode:t.data.imgMode}};if(t.data.showWithAnimation&&(i.showAnimation=showAnimation,i.hideAnimation=hideAnimation),e)if("string"==typeof e){if(t.data.useCache){var r=Hash(e);cache[r]?i.html=cache[r]:(i.html=parseHtmlSync(e,t.data),cache[r]=i.html)}else i.html=parseHtmlSync(e,t.data);t.triggerEvent("parse",i.html)}else if(e.constructor==Array){if(e.length&&"Parser"!=e[0].PoweredBy){var s={_imgNum:0,_videoNum:0,_audioNum:0,_domain:t.data.domain,_protocol:t.data.domain?t.data.domain.includes("://")?t.data.domain.split("://")[0]:"http":void 0,_STACK:[],CssHandler:new CssHandler(t.data.tagStyle)};s.CssHandler.getStyle(""),function t(e){for(var n,o=0;n=e[o++];)if("text"!=n.type){n.attrs=n.attrs||{};for(var a in n.attrs)config.trustAttrs[a]?"string"!=typeof n.attrs[a]&&(n.attrs[a]=n.attrs[a].toString()):n.attrs[a]=void 0;config.LabelAttrsHandler(n,s),config.blockTags[n.name]?n.name="div":config.trustTags[n.name]||(n.name="span"),n.children&&n.children.length?(s._STACK.push(n),t(n.children),s._STACK.pop()):n.children=void 0}}(e),i.html=e}o||(i.html=e)}else{if("object"!=(void 0===e?"undefined":_typeof(e))||!e.nodes)return t.triggerEvent("error",{source:"parse",errMsg:"错误的html类型："+(void 0===e?"undefined":_typeof(e))});i.html=e.nodes,console.warn("Parser 类型错误：object 类型已废弃，请直接将 html 设置为 object.nodes （array 类型）")}else{if(o)return;i.html=""}t._refresh=!!i.html,t.setData(i),t.imgList.length=0,t.videoContexts=[],document&&(t.document=new document("html",i.html||e,t));for(var l=[t.selectComponent("#contain")].concat(t.selectAllComponents("#contain>>>._node")),c=l.length;c--;){var d,u,m,u,m,h;!function(){var e=l[c];for(e._top=t,d=!!e._observer,u=e.data.nodes.length,u=e.data.nodes.length;m=e.data.nodes[--u];)m.continue||("img"==m.name?(m.attrs.src&&m.attrs.i&&(-1==t.imgList.indexOf(m.attrs.src)?t.imgList[m.attrs.i]=m.attrs.src:t.imgList[m.attrs.i]=Deduplication(m.attrs.src)),d||(d=!0,(wx.nextTick||setTimeout)(function(){t.data.lazyLoad&&e.createIntersectionObserver?(e._observer=e.createIntersectionObserver(),e._observer.relativeToViewport({top:1e3,bottom:1e3}).observe("._img",function(){e.setData({imgLoad:!0}),e._observer.disconnect(),e._observer=void 0})):e.setData({imgLoad:!0})},50))):"video"==m.name?(h=wx.createVideoContext(m.attrs.id,e),h.id=m.attrs.id,t.videoContexts.push(h)):"audio"==m.name&&m.attrs.autoplay?wx.createAudioContext(m.attrs.id,e).play():"title"==m.name&&t.data.autosetTitle&&"text"==m.children[0].type&&m.children[0].text&&wx.setNavigationBarTitle({title:m.children[0].text}))}()}(wx.nextTick||setTimeout)(function(){t.createSelectorQuery().select("#contain").boundingClientRect(function(e){t.triggerEvent("ready",e)}).exec()},50)}}});